<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Game</title>
</head>
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    :root{
        --cell-height:60px;
        --cell-width:60px
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f0f0;
        font-family: Arial, sans-serif;
    }

    .grid-container {
        display: grid;
        grid-template-rows: repeat(10,var(--cell-width));
        grid-template-columns: repeat(10,var(--cell-width));
        gap: 0px;
    }

    .grid-cell {
        background-color: #ddd;
        border: 2px solid #aaa;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        cursor: pointer;
        width: var(--cell-width);
    }

    .track-straight {
        background-color: #aaf;
    }

    .track-curve {
        background-color: #faa;
    }

    .track-junction {
        background-color: #afa;
    }

    .track-empty {
        background-color: #ddd;
    }

    .start {
        background-color: #974f4f
    }

    .end {
        background-color: aqua;
    }

    .train {
        width: var(--cell-width);
        height: var(--cell-width);
        border: red solid;
        position: absolute;
        text-align: center;
    }

    @media(max-width:500px) {
        :root{
            --cell-width:35px
        }
    }
</style>

<body>
    <div class="grid-container"></div>
</body>
<script>
    const gridSize = 10
    let gridMatrix = new Array(gridSize)
    for (var i = 0; i < gridSize; i++) {
        gridMatrix[i] = new Array(gridSize)
    }
    for (var i = 0; i < gridSize; i++) {
        for (var j = 0; j < gridSize; j++) {
            gridMatrix[i][j] = "5.0"
        }
    }
    // mapping
    // ends
    gridMatrix[0][2] = "4.0.1"
    gridMatrix[7][0] = "4.0.2"
    gridMatrix[9][0] = "4.0.3"
    gridMatrix[8][3] = "4.0.4"
    gridMatrix[6][7] = "4.0.5"
    gridMatrix[2][7] = "4.0.6"
    gridMatrix[0][7] = "4.0.7"
    // start
    gridMatrix[2][1] = "0.1"
    // junctions
    gridMatrix[7][1] = "3.3"
    gridMatrix[5][3] = "3.3"
    gridMatrix[5][5] = "3.3"
    gridMatrix[2][5] = "3.3"
    gridMatrix[0][5] = "3.3"
    // path
    gridMatrix[0][3] = "1.3"
    gridMatrix[0][4] = "1.3"
    gridMatrix[0][6] = "1.1"
    gridMatrix[1][5] = "1.0"
    gridMatrix[2][2] = "1.1"
    gridMatrix[2][6] = "1.1"
    gridMatrix[2][3] = "1.2"
    gridMatrix[3][3] = "1.2"
    gridMatrix[3][5] = "1.0"
    gridMatrix[4][3] = "1.2"
    gridMatrix[4][5] = "1.0"
    gridMatrix[5][1] = "1.2"
    gridMatrix[5][2] = "1.3"
    gridMatrix[5][4] = "1.1"
    gridMatrix[6][1] = "1.2"
    gridMatrix[6][3] = "1.2"
    gridMatrix[6][5] = "1.1"
    gridMatrix[6][6] = "1.1"
    gridMatrix[7][3] = "1.2"
    gridMatrix[8][1] = "1.2"
    gridMatrix[9][1] = "1.3"
    // -------

    const track_directions = [
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.14645 2.14645C7.34171 1.95118 7.65829 1.95118 7.85355 2.14645L11.8536 6.14645C12.0488 6.34171 12.0488 6.65829 11.8536 6.85355C11.6583 7.04882 11.3417 7.04882 11.1464 6.85355L8 3.70711L8 12.5C8 12.7761 7.77614 13 7.5 13C7.22386 13 7 12.7761 7 12.5L7 3.70711L3.85355 6.85355C3.65829 7.04882 3.34171 7.04882 3.14645 6.85355C2.95118 6.65829 2.95118 6.34171 3.14645 6.14645L7.14645 2.14645Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.14645 3.14645C8.34171 2.95118 8.65829 2.95118 8.85355 3.14645L12.8536 7.14645C13.0488 7.34171 13.0488 7.65829 12.8536 7.85355L8.85355 11.8536C8.65829 12.0488 8.34171 12.0488 8.14645 11.8536C7.95118 11.6583 7.95118 11.3417 8.14645 11.1464L11.2929 8H2.5C2.22386 8 2 7.77614 2 7.5C2 7.22386 2.22386 7 2.5 7H11.2929L8.14645 3.85355C7.95118 3.65829 7.95118 3.34171 8.14645 3.14645Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 2C7.77614 2 8 2.22386 8 2.5L8 11.2929L11.1464 8.14645C11.3417 7.95118 11.6583 7.95118 11.8536 8.14645C12.0488 8.34171 12.0488 8.65829 11.8536 8.85355L7.85355 12.8536C7.75979 12.9473 7.63261 13 7.5 13C7.36739 13 7.24021 12.9473 7.14645 12.8536L3.14645 8.85355C2.95118 8.65829 2.95118 8.34171 3.14645 8.14645C3.34171 7.95118 3.65829 7.95118 3.85355 8.14645L7 11.2929L7 2.5C7 2.22386 7.22386 2 7.5 2Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.85355 3.14645C7.04882 3.34171 7.04882 3.65829 6.85355 3.85355L3.70711 7H12.5C12.7761 7 13 7.22386 13 7.5C13 7.77614 12.7761 8 12.5 8H3.70711L6.85355 11.1464C7.04882 11.3417 7.04882 11.6583 6.85355 11.8536C6.65829 12.0488 6.34171 12.0488 6.14645 11.8536L2.14645 7.85355C1.95118 7.65829 1.95118 7.34171 2.14645 7.14645L6.14645 3.14645C6.34171 2.95118 6.65829 2.95118 6.85355 3.14645Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
    ]
    
    const start_directions = [
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 3C9 2.44772 8.55229 2 8 2H7C6.44772 2 6 2.44772 6 3L6 14H1.5C1.22386 14 1 14.2239 1 14.5C1 14.7761 1.22386 15 1.5 15L6 15H9H13.5C13.7761 15 14 14.7761 14 14.5C14 14.2239 13.7761 14 13.5 14H9V3Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.499995 0.999995C0.223855 0.999995 -5.58458e-07 1.22385 -5.46388e-07 1.49999L-2.18554e-08 13.4999C-9.78492e-09 13.776 0.223855 13.9999 0.499995 13.9999C0.776136 13.9999 0.999991 13.776 0.999991 13.4999L0.999991 8.99993L12 8.99993C12.5523 8.99993 13 8.55222 13 7.99993L13 6.99994C13 6.44766 12.5523 5.99995 12 5.99995L0.999991 5.99995L0.999991 1.49999C0.999991 1.22385 0.776135 0.999995 0.499995 0.999995Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 0C1.22386 0 1 0.223858 1 0.5C1 0.776142 1.22386 1 1.5 1H6V12C6 12.5523 6.44772 13 7 13H8C8.55228 13 9 12.5523 9 12V1H13.5C13.7761 1 14 0.776142 14 0.5C14 0.223858 13.7761 0 13.5 0H9H6H1.5Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.4999 1C14.2237 1 13.9999 1.22386 13.9999 1.5L13.9999 6L2.99988 6C2.44759 6 1.99988 6.44772 1.99988 7L1.99988 8C1.99988 8.55228 2.44759 9 2.99988 9L13.9999 9L13.9999 13.5C13.9999 13.7761 14.2237 14 14.4999 14C14.776 14 14.9999 13.7761 14.9999 13.5L14.9999 9L14.9999 6L14.9999 1.5C14.9999 1.22386 14.776 1 14.4999 1Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
    ]
    
    var junctions_valid_directions = []
    
    document.addEventListener("DOMContentLoaded", grid_generator(gridSize,gridMatrix));
    
    async function grid_generator(size, gridMatrix) {
        const gridSize = size;
        const gridContainer = document.querySelector(".grid-container");
        gridContainer.innerHTML = '';
        var junctionNum = 0
        for (let row = 0; row < gridSize; row++) {
            for (let col = 0; col < gridSize; col++) {
                var a = gridMatrix[row][col].split(".")
                var nodeType = a[0]
                var FacingDirection = a[1]
                if (nodeType == 4) {
                    var end_point = a[2]
                }
                const cell = document.createElement("div");
                cell.innerHTML = track_directions[FacingDirection]
                cell.setAttribute("data-direction", FacingDirection)
                if (nodeType === '0') {
                    cell.innerHTML = ""
                    cell.innerHTML = start_directions[FacingDirection]
                    cell.classList.add("grid-cell", "start");
                }
                else if (nodeType == '1') {
                    cell.classList.add("grid-cell", "track-straight");
                }
                else if (nodeType == '2') {
                    cell.classList.add("grid-cell", "track-curve");
                }
                else if (nodeType === '3') {
                    cell.classList.add("grid-cell", "track-junction");
                    cell.setAttribute("data-junction-num", junctionNum++)
                    cell.addEventListener("click", () => toggleTrack(cell));
                }
                else if (nodeType == '4') {
                    cell.innerHTML = ""
                    cell.innerHTML = `${end_point}`
                    cell.setAttribute("data-end", end_point)
                    cell.classList.add("grid-cell", "end");
                }
                else if (nodeType == '5') {
                    cell.classList.add("grid-cell", "track-empty");
                    cell.innerHTML = ""
                }
                else {
                    break
                }
                cell.dataset.row = row;
                cell.dataset.col = col;
                gridContainer.appendChild(cell);
            }
        }
        generate_junctions_valid_directions()
    }
    
    function generate_junctions_valid_directions() {
        const temp = [];
        const directions = [
            [-1, 0],
            [0, 1],
            [1, 0],
            [0, -1]
        ];
        gridMatrix.forEach((row, i) => {
            row.forEach((k, j) => {
                if (k.startsWith("3")) {
                    temp.push([i, j]);
                }
            });
        });
        temp.forEach(([r, c]) => {
            const temp2 = [0, 0, 0, 0];
            directions.forEach(([dr, dc], idx) => {
                const newRow = r + dr;
                const newCol = c + dc;
                if (newRow >= 0 && newRow < gridMatrix.length && newCol >= 0 && newCol < gridMatrix[0].length) {
                    const neighbor = gridMatrix[newRow][newCol];
                    const [type, direction] = neighbor.split(".");
                    if (type !== "5" && +direction !== (idx + 2) % 4) {
                        temp2[idx] = 1;
                    }
                }
            });
            junctions_valid_directions.push(temp2);
        });
    }
    
    async function toggleTrack(cell) {
        cur_d = parseInt(cell.dataset.direction)
        jun_num = parseInt(cell.dataset.junctionNum)
        next_d = (cur_d + 1) % 4
        while (junctions_valid_directions[jun_num][next_d] == 0) next_d = (next_d + 1) % 4
        cell.setAttribute("data-direction", next_d)
        cell.innerHTML = ""
        cell.innerHTML = track_directions[next_d]
    }
    
    async function train_init(id, endPoint, speed) {
        const start = document.querySelector(".start");
        const { x, y } = start.getBoundingClientRect();
        const d = +start.dataset.direction;
        const train = document.createElement("div");
        train.id = `train_${id}`;
        train.className = "train";
        train.dataset.end = endPoint;
        train.style.left = `${x}px`;
        train.style.top = `${y}px`;
        train.innerHTML = `<div>${endPoint}</div>`;
        document.body.appendChild(train);
        let s_r = +start.dataset.row;
        let s_c = +start.dataset.col;
        const directionMap = {
            0: () => s_r--,
            1: () => s_c++,
            2: () => s_r++,
            3: () => s_c--
        };
        directionMap[d]();
        train_move(id, [s_r, s_c], speed);
    }
    
    function train_move(id, current, speed) {
        setTimeout(() => {
            const train = document.querySelector(`#train_${id}`);
            const current_cell = document.querySelector(`.grid-cell[data-row="${current[0]}"][data-col="${current[1]}"]`);
            if (!current_cell) {
                console.error("Next cell not found");
                return;
            }
            const rect = current_cell.getBoundingClientRect();
            const x = rect.left + window.scrollX;
            const y = rect.top + window.scrollY;
            const d = current_cell.dataset.direction;
            train.style.left = `${x}px`;
            train.style.top = `${y}px`;
            train.style.transition = `1s`;
            var a = current_cell.dataset.end
            if (!!a) {
                if (a == train.dataset.end) {
                    console.log("Won +1");
                }
                else {
                    console.log("Lost -1");
                }
                setTimeout(() => {
                    document.querySelector(`#train_${id}`).remove()
                }, 1000);
                delete active_ids[id]
                return true
            }
            let s_r = parseInt(current_cell.dataset.row);
            let s_c = parseInt(current_cell.dataset.col);
            if (d == 0) --s_r;
            else if (d == 1) ++s_c;
            else if (d == 2) ++s_r;
            else if (d == 3) --s_c;
            train_move(id, [s_r, s_c], speed);
        }, (1 / speed) * 5000);
    }
    
    let res = []
    
    let active_ids = {}
    
    for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
            var a = gridMatrix[row][col].split(".")
            if (a[0] == 4) res.push(parseInt(a[2]))
        }
    }
    
    function getRandomElementFromOne() {
        if (res.length < 2) {
            return null;
        }
        const randomIndex = Math.floor(Math.random() * (res.length));
        return res[randomIndex];
    }
    
    function getRandomNumber() {
        var res = Math.floor(Math.random() * 100) + 1;
        while (active_ids[res]) {
            res = Math.floor(Math.random() * 100) + 1;
        }
        active_ids[res] = 1
        return res
    }
    
    setInterval(async () => {
        end = getRandomElementFromOne()
        id = getRandomNumber()
        await train_init(id, end, 3)
    }, 4500);
</script>

</html>