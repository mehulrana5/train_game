<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Game</title>
</head>
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f0f0;
        font-family: Arial, sans-serif;
    }

    .grid-container {
        display: grid;
        grid-template-columns: repeat(4, 60px);
        grid-template-rows: repeat(4, 60px);
        gap: 0px;
    }

    .grid-cell {
        background-color: #ddd;
        border: 2px solid #aaa;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        cursor: pointer;
    }

    .track-straight {
        background-color: #aaf;
    }

    .track-curve {
        background-color: #faa;
    }

    .track-junction {
        background-color: #afa;
    }

    .track-empty {
        background-color: #ddd;
    }

    .start {
        background-color: #974f4f
    }

    .end {
        background-color: aqua;
    }

    .train {
        width: 60px;
        height: 60px;
        border: red solid;
        position: absolute;
        text-align: center;
    }
</style>

<body>
    <div class="grid-container"></div>
</body>
<script>
    const size = 4
    const gridMatrix = [
        ['0.1', '1.1', '1.2','5.0'],
        ['4.0.1', '1.3','1.2', '5.0'],
        ['5.0', '1.0', '1.2','5.0'],
        ['4.0.2', '3.3', '3.3', '4.0.3']
    ]
    const track_directions = [
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.14645 2.14645C7.34171 1.95118 7.65829 1.95118 7.85355 2.14645L11.8536 6.14645C12.0488 6.34171 12.0488 6.65829 11.8536 6.85355C11.6583 7.04882 11.3417 7.04882 11.1464 6.85355L8 3.70711L8 12.5C8 12.7761 7.77614 13 7.5 13C7.22386 13 7 12.7761 7 12.5L7 3.70711L3.85355 6.85355C3.65829 7.04882 3.34171 7.04882 3.14645 6.85355C2.95118 6.65829 2.95118 6.34171 3.14645 6.14645L7.14645 2.14645Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        // `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.64645 11.3536C3.45118 11.1583 3.45118 10.8417 3.64645 10.6465L10.2929 4L6 4C5.72386 4 5.5 3.77614 5.5 3.5C5.5 3.22386 5.72386 3 6 3L11.5 3C11.6326 3 11.7598 3.05268 11.8536 3.14645C11.9473 3.24022 12 3.36739 12 3.5L12 9.00001C12 9.27615 11.7761 9.50001 11.5 9.50001C11.2239 9.50001 11 9.27615 11 9.00001V4.70711L4.35355 11.3536C4.15829 11.5488 3.84171 11.5488 3.64645 11.3536Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.14645 3.14645C8.34171 2.95118 8.65829 2.95118 8.85355 3.14645L12.8536 7.14645C13.0488 7.34171 13.0488 7.65829 12.8536 7.85355L8.85355 11.8536C8.65829 12.0488 8.34171 12.0488 8.14645 11.8536C7.95118 11.6583 7.95118 11.3417 8.14645 11.1464L11.2929 8H2.5C2.22386 8 2 7.77614 2 7.5C2 7.22386 2.22386 7 2.5 7H11.2929L8.14645 3.85355C7.95118 3.65829 7.95118 3.34171 8.14645 3.14645Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        // `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.64645 3.64644C3.45118 3.8417 3.45118 4.15828 3.64645 4.35354L10.2929 11L6 11C5.72386 11 5.5 11.2239 5.5 11.5C5.5 11.7761 5.72386 12 6 12L11.5 12C11.6326 12 11.7598 11.9473 11.8536 11.8536C11.9473 11.7598 12 11.6326 12 11.5L12 5.99999C12 5.72385 11.7761 5.49999 11.5 5.49999C11.2239 5.49999 11 5.72385 11 5.99999V10.2929L4.35355 3.64643C4.15829 3.45117 3.84171 3.45117 3.64645 3.64644Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 2C7.77614 2 8 2.22386 8 2.5L8 11.2929L11.1464 8.14645C11.3417 7.95118 11.6583 7.95118 11.8536 8.14645C12.0488 8.34171 12.0488 8.65829 11.8536 8.85355L7.85355 12.8536C7.75979 12.9473 7.63261 13 7.5 13C7.36739 13 7.24021 12.9473 7.14645 12.8536L3.14645 8.85355C2.95118 8.65829 2.95118 8.34171 3.14645 8.14645C3.34171 7.95118 3.65829 7.95118 3.85355 8.14645L7 11.2929L7 2.5C7 2.22386 7.22386 2 7.5 2Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        // `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.3536 3.64644C11.5488 3.8417 11.5488 4.15828 11.3536 4.35354L4.70711 11L9 11C9.27614 11 9.5 11.2239 9.5 11.5C9.5 11.7761 9.27614 12 9 12L3.5 12C3.36739 12 3.24021 11.9473 3.14645 11.8536C3.05268 11.7598 3 11.6326 3 11.5L3 5.99999C3 5.72385 3.22386 5.49999 3.5 5.49999C3.77614 5.49999 4 5.72385 4 5.99999V10.2929L10.6464 3.64643C10.8417 3.45117 11.1583 3.45117 11.3536 3.64644Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.85355 3.14645C7.04882 3.34171 7.04882 3.65829 6.85355 3.85355L3.70711 7H12.5C12.7761 7 13 7.22386 13 7.5C13 7.77614 12.7761 8 12.5 8H3.70711L6.85355 11.1464C7.04882 11.3417 7.04882 11.6583 6.85355 11.8536C6.65829 12.0488 6.34171 12.0488 6.14645 11.8536L2.14645 7.85355C1.95118 7.65829 1.95118 7.34171 2.14645 7.14645L6.14645 3.14645C6.34171 2.95118 6.65829 2.95118 6.85355 3.14645Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        // `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.3536 11.3536C11.5488 11.1583 11.5488 10.8417 11.3536 10.6465L4.70711 4L9 4C9.27614 4 9.5 3.77614 9.5 3.5C9.5 3.22386 9.27614 3 9 3L3.5 3C3.36739 3 3.24021 3.05268 3.14645 3.14645C3.05268 3.24022 3 3.36739 3 3.5L3 9.00001C3 9.27615 3.22386 9.50001 3.5 9.50001C3.77614 9.50001 4 9.27615 4 9.00001V4.70711L10.6464 11.3536C10.8417 11.5488 11.1583 11.5488 11.3536 11.3536Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`
    ]
    const start_directions = [
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 3C9 2.44772 8.55229 2 8 2H7C6.44772 2 6 2.44772 6 3L6 14H1.5C1.22386 14 1 14.2239 1 14.5C1 14.7761 1.22386 15 1.5 15L6 15H9H13.5C13.7761 15 14 14.7761 14 14.5C14 14.2239 13.7761 14 13.5 14H9V3Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.499995 0.999995C0.223855 0.999995 -5.58458e-07 1.22385 -5.46388e-07 1.49999L-2.18554e-08 13.4999C-9.78492e-09 13.776 0.223855 13.9999 0.499995 13.9999C0.776136 13.9999 0.999991 13.776 0.999991 13.4999L0.999991 8.99993L12 8.99993C12.5523 8.99993 13 8.55222 13 7.99993L13 6.99994C13 6.44766 12.5523 5.99995 12 5.99995L0.999991 5.99995L0.999991 1.49999C0.999991 1.22385 0.776135 0.999995 0.499995 0.999995Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 0C1.22386 0 1 0.223858 1 0.5C1 0.776142 1.22386 1 1.5 1H6V12C6 12.5523 6.44772 13 7 13H8C8.55228 13 9 12.5523 9 12V1H13.5C13.7761 1 14 0.776142 14 0.5C14 0.223858 13.7761 0 13.5 0H9H6H1.5Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
        `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.4999 1C14.2237 1 13.9999 1.22386 13.9999 1.5L13.9999 6L2.99988 6C2.44759 6 1.99988 6.44772 1.99988 7L1.99988 8C1.99988 8.55228 2.44759 9 2.99988 9L13.9999 9L13.9999 13.5C13.9999 13.7761 14.2237 14 14.4999 14C14.776 14 14.9999 13.7761 14.9999 13.5L14.9999 9L14.9999 6L14.9999 1.5C14.9999 1.22386 14.776 1 14.4999 1Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`,
    ]
    document.addEventListener("DOMContentLoaded", grid_init(size));
    async function grid_init(size) {
        const gridContainer = document.querySelector(".grid-container");
        gridContainer.innerHTML = '';
        gridContainer.style.gridTemplateColumns = `repeat(${size}, 60px)`;
        await grid_generator(size, gridMatrix)
    }
    async function grid_generator(size, gridMatrix) {
        const gridSize = size;
        const gridContainer = document.querySelector(".grid-container");
        gridContainer.innerHTML = '';
        for (let row = 0; row < gridSize; row++) {
            for (let col = 0; col < gridSize; col++) {
                var a = gridMatrix[row][col].split(".")
                var nodeType = a[0]
                var FacingDirection = a[1]
                if (nodeType == 4) {
                    var end_point = a[2]
                }
                const cell = document.createElement("div");
                cell.innerHTML = track_directions[FacingDirection]
                cell.setAttribute("data-direction", FacingDirection)
                if (nodeType === '0') {
                    cell.innerHTML = ""
                    cell.innerHTML = start_directions[FacingDirection]
                    cell.classList.add("grid-cell", "start");
                }
                else if (nodeType == '1') {
                    cell.classList.add("grid-cell", "track-straight");
                }
                else if (nodeType == '2') {
                    cell.classList.add("grid-cell", "track-curve");
                }
                else if (nodeType === '3') {
                    cell.classList.add("grid-cell", "track-junction");
                    cell.addEventListener("click", () => toggleTrack(cell));
                }
                else if (nodeType == '4') {
                    cell.innerHTML = ""
                    cell.innerHTML = `${end_point}`
                    cell.setAttribute("data-end", end_point)
                    cell.classList.add("grid-cell", "end");
                }
                else if (nodeType == '5') {
                    cell.classList.add("grid-cell", "track-empty");
                    cell.innerHTML = ""
                }
                else {
                    break
                }
                cell.dataset.row = row;
                cell.dataset.col = col;
                gridContainer.appendChild(cell);
            }
        }
    }
    async function toggleTrack(cell) {
        var d = 0
        if (cell.innerHTML == track_directions[0]) {
            cell.innerHTML = track_directions[1]
            d = 1
        }
        else if (cell.innerHTML == track_directions[1]) {
            cell.innerHTML = track_directions[2]
            d = 2
        }
        else if (cell.innerHTML == track_directions[2]) {
            cell.innerHTML = track_directions[3]
            d = 3
        }
        else {
            cell.innerHTML = track_directions[0]
            d = 0
        }
        cell.setAttribute("data-direction", d)
    }
    async function train_init(id, endPoint, speed) {
        const start = document.querySelector(".start")
        const x = start.getBoundingClientRect().x
        const y = start.getBoundingClientRect().y
        const d = start.dataset.direction
        const a = document.createElement("div")
        a.setAttribute("id", `train_${id}`)
        a.setAttribute("class", "train")
        a.innerHTML = `<div>${id}</div>`
        document.body.appendChild(a);
        const train = document.querySelector(".train")
        train.setAttribute("data-end", endPoint)
        train.style.left = `${x}px`
        train.style.top = `${y}px`
        var s_r = parseInt(start.dataset.row)
        var s_c = parseInt(start.dataset.col)
        if (d == 0) --s_r
        else if (d == 1) ++s_c
        else if (d == 2) ++s_r
        else --s_c
        await train_move(id, [s_r, s_c], speed)
    }
    async function train_move(id, current, speed) {
        setTimeout(() => {
            const train = document.querySelector(".train");
            const current_cell = document.querySelector(`.grid-cell[data-row="${current[0]}"][data-col="${current[1]}"]`);

            if (!current_cell) {
                console.error("Next cell not found");
                return;
            }
            const rect = current_cell.getBoundingClientRect();
            const x = rect.left + window.scrollX;
            const y = rect.top + window.scrollY;
            const d = current_cell.dataset.direction;
            train.style.left = `${x}px`;
            train.style.top = `${y}px`;
            train.style.transition = `1s`;
            var a = current_cell.dataset.end
            if (!!a) {
                if (a == train.dataset.end) {
                    console.log("Won +1");
                }
                else {
                    console.log("Lost -1");
                }
                setTimeout(() => {
                    document.querySelector(`#train_${id}`).remove()
                }, 1000);
                return true
            }
            let s_r = parseInt(current_cell.dataset.row);
            let s_c = parseInt(current_cell.dataset.col);
            if (d == 0) --s_r; // Up
            else if (d == 1) ++s_c; // Right
            else if (d == 2) ++s_r; // Down
            else if (d == 3) --s_c; // Left
            train_move(id, [s_r, s_c], speed);
        }, (1 / speed) * 5000);
    }

    let res = []
    for (let row = 0; row < size; row++) {
        for (let col = 0; col < size; col++) {
            var a = gridMatrix[row][col].split(".")
            if (a[0] == 4) res.push(parseInt(a[2]))
        }
    }
    function getRandomElementFromOne() {
        if (res.length < 2) {
            return null;
        }
        const randomIndex = Math.floor(Math.random() * (res.length));
        return res[randomIndex];
    }

    setInterval(async () => {
        end=getRandomElementFromOne()
        await train_init(end, end, 8)
    }, 5500);
</script>

</html>